<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"1330571.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"default"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="simple rust multi-classification">
<meta property="og:type" content="article">
<meta property="og:title" content="Rust ML with tch-rs">
<meta property="og:url" content="http://1330571.github.io/posts/45670/index.html">
<meta property="og:site_name" content="BaiLan Life">
<meta property="og:description" content="simple rust multi-classification">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2022-11-23T11:03:12.000Z">
<meta property="article:modified_time" content="2022-11-23T15:48:53.389Z">
<meta property="article:author" content="YuSheng Xu">
<meta property="article:tag" content="rust">
<meta property="article:tag" content="machine learning">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://1330571.github.io/posts/45670/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>Rust ML with tch-rs | BaiLan Life</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --></head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">BaiLan Life</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://1330571.github.io/posts/45670/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="YuSheng Xu">
      <meta itemprop="description" content="Study & Work & Life">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BaiLan Life">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Rust ML with tch-rs
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-11-23 19:03:12 / Modified: 23:48:53" itemprop="dateCreated datePublished" datetime="2022-11-23T19:03:12+08:00">2022-11-23</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/rust/" itemprop="url" rel="index"><span itemprop="name">rust</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>12k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>11 mins.</span>
            </span>
            <div class="post-description">simple rust multi-classification</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>In this post, we use <a target="_blank" rel="noopener" href="https://github.com/LaurentMazare/tch-rs">tch-rs</a> and <a target="_blank" rel="noopener" href="https://github.com/serde-rs/serde">serde</a> to do multi-classification tasks.</p>
<p>To configure the tch-rs is really struggling, please follow the tch-rs github page to configure everything for your specific OS system.</p>
<p>The dataset is similar to <a target="_blank" rel="noopener" href="https://www.kaggle.com/datasets/ruthgn/wine-quality-data-set-red-white-wine">Wine Quality</a> but with some modifications bacause it is my homework, the teaching assistant modifies the dataset, and the dataset is split into 2 parts and I don’t know how they split it. And the method in this paper only gets ~54% acc. This post is just a try to use rust to read data and train models and realize an ML pipeline.</p>
<p>First let us import the packages we use, we should put these lines to <code>cargo.toml</code>.</p>
<figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"><span class="attr">tch</span> = <span class="string">&#x27;0.9.0&#x27;</span></span><br><span class="line"><span class="attr">anyhow</span> = <span class="string">&quot;1.0.48&quot;</span></span><br><span class="line"><span class="attr">csv</span> = <span class="string">&quot;1.1.6&quot;</span></span><br><span class="line"><span class="attr">serde</span> = &#123; version = <span class="string">&quot;1.0.147&quot;</span>, features = [<span class="string">&quot;derive&quot;</span>] &#125;</span><br><span class="line"><span class="attr">rand</span> = <span class="string">&quot;0.8.5&quot;</span></span><br><span class="line"><span class="attr">lazy_static</span> = <span class="string">&quot;1.4.0&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="Read-data"><a href="#Read-data" class="headerlink" title="Read data"></a>Read data</h2><p>The data was in <code>csv</code> format, so we make a structure to read csv data.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">CsvReader</span> &#123;</span><br><span class="line">    filepath: <span class="type">String</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">CsvReader</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>(filepath: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> CsvReader &#123;</span><br><span class="line">        CsvReader &#123;</span><br><span class="line">            filepath: <span class="type">String</span>::<span class="title function_ invoke__">from</span>(filepath),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>To get data and feed it into a neural network, we should make an interface to handle these things. the first one is used to get all data in the csv file, the second one ended with ‘force’ means when an error occurs we use template value to replace the value cause some field in the dataset is null.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">trait</span> <span class="title class_">ReadData</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">get_data</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="type">Vec</span>&lt;T&gt;, <span class="type">Box</span>&lt;<span class="keyword">dyn</span> Error&gt;&gt;;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">get_data_force</span>(&amp;<span class="keyword">self</span>, template: T) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="type">Vec</span>&lt;T&gt;, <span class="type">Box</span>&lt;<span class="keyword">dyn</span> Error&gt;&gt;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Implement the ReadData<T> interface, this is quite straightforward, just read data use csv crate and use serde to deserialize it into our data structure in rust.</T></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span>&lt;T: <span class="keyword">for</span>&lt;<span class="symbol">&#x27;de</span>&gt; serde::de::Deserialize&lt;<span class="symbol">&#x27;de</span>&gt; + <span class="built_in">Clone</span>&gt; ReadData&lt;T&gt; <span class="keyword">for</span> <span class="title class_">CsvReader</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">get_data</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="type">Vec</span>&lt;T&gt;, <span class="type">Box</span>&lt;<span class="keyword">dyn</span> Error&gt;&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">file</span> = File::<span class="title function_ invoke__">open</span>(&amp;<span class="keyword">self</span>.filepath)?;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">result</span>: <span class="type">Vec</span>&lt;T&gt; = <span class="type">Vec</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">rdr</span> = csv::Reader::<span class="title function_ invoke__">from_reader</span>(file);</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">index</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> <span class="variable">item</span> <span class="keyword">in</span> rdr.<span class="title function_ invoke__">deserialize</span>() &#123;</span><br><span class="line">            index += <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">match</span> item &#123;</span><br><span class="line">                <span class="title function_ invoke__">Ok</span>(record) =&gt; result.<span class="title function_ invoke__">push</span>(record),</span><br><span class="line">                <span class="title function_ invoke__">Err</span>(_) =&gt; <span class="built_in">println!</span>(<span class="string">&quot;data &#123;:4&#125; had error and was skipped&quot;</span>, index),</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(result)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">get_data_force</span>(&amp;<span class="keyword">self</span>, template: T) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="type">Vec</span>&lt;T&gt;, <span class="type">Box</span>&lt;<span class="keyword">dyn</span> Error&gt;&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">file</span> = File::<span class="title function_ invoke__">open</span>(&amp;<span class="keyword">self</span>.filepath)?;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">result</span>: <span class="type">Vec</span>&lt;T&gt; = <span class="type">Vec</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">rdr</span> = csv::Reader::<span class="title function_ invoke__">from_reader</span>(file);</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">index</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> <span class="variable">item</span> <span class="keyword">in</span> rdr.<span class="title function_ invoke__">deserialize</span>() &#123;</span><br><span class="line">            index += <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">match</span> item &#123;</span><br><span class="line">                <span class="title function_ invoke__">Ok</span>(record) =&gt; result.<span class="title function_ invoke__">push</span>(record),</span><br><span class="line">                <span class="title function_ invoke__">Err</span>(_) =&gt; result.<span class="title function_ invoke__">push</span>(template.<span class="title function_ invoke__">clone</span>()),</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(result)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Then we use a test to read data and we use <code>WineQualityData</code> to represent the data in train.csv.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[allow(non_snake_case)]</span></span><br><span class="line"><span class="meta">#[allow(non_camel_case_types)]</span></span><br><span class="line"><span class="meta">#[derive(Debug, Deserialize, Clone)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">WineQualityData</span> &#123;</span><br><span class="line">    <span class="meta">#[serde(rename = <span class="string">&quot;type&quot;</span>)]</span></span><br><span class="line">    wine_type: <span class="type">String</span>,</span><br><span class="line">    <span class="meta">#[serde(rename = <span class="string">&quot;fixed acidity&quot;</span>)]</span></span><br><span class="line">    fixed_acidity: <span class="type">f64</span>,</span><br><span class="line">    <span class="meta">#[serde(rename = <span class="string">&quot;volatile acidity&quot;</span>)]</span></span><br><span class="line">    volatile_acidity: <span class="type">f64</span>,</span><br><span class="line">    <span class="meta">#[serde(rename = <span class="string">&quot;citric acid&quot;</span>)]</span></span><br><span class="line">    citric_acid: <span class="type">f64</span>,</span><br><span class="line">    <span class="meta">#[serde(rename = <span class="string">&quot;residual sugar&quot;</span>)]</span></span><br><span class="line">    residual_sugar: <span class="type">f64</span>,</span><br><span class="line">    chlorides: <span class="type">f64</span>,</span><br><span class="line">    <span class="meta">#[serde(rename = <span class="string">&quot;free sulfur dioxide&quot;</span>)]</span></span><br><span class="line">    free_sulfur_dioxide: <span class="type">f64</span>,</span><br><span class="line">    <span class="meta">#[serde(rename = <span class="string">&quot;total sulfur dioxide&quot;</span>)]</span></span><br><span class="line">    total_sulfur_dioxide: <span class="type">f64</span>,</span><br><span class="line">    density: <span class="type">f64</span>,</span><br><span class="line">    pH: <span class="type">f64</span>,</span><br><span class="line">    sulphates: <span class="type">f64</span>,</span><br><span class="line">    alcohol: <span class="type">f64</span>,</span><br><span class="line">    quality: <span class="type">f64</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>the test code is following.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">test_read_wine_data</span>() <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;(), <span class="type">Box</span>&lt;<span class="keyword">dyn</span> Error&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">reader</span> = CsvReader::<span class="title function_ invoke__">new</span>(<span class="string">&quot;./wine_dataset/train.csv&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">data</span>: <span class="type">Vec</span>&lt;WineQualityData&gt; = reader.<span class="title function_ invoke__">get_data</span>()?;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;read &#123;&#125; data&quot;</span>, data.<span class="title function_ invoke__">len</span>());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">summary</span> = HashMap::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">data</span> <span class="keyword">in</span> data.<span class="title function_ invoke__">iter</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">v</span> = data.<span class="title function_ invoke__">get_quality</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">entry</span> = summary.<span class="title function_ invoke__">entry</span>(v).<span class="title function_ invoke__">or_insert</span>(<span class="number">0</span>);</span><br><span class="line">        *entry += <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">for</span> (k, v) <span class="keyword">in</span> &amp;summary &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;&#123;:2&#125; - &#123;:2&#125;&quot;</span>, k, v);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>we run the test and it prints the data’s quality distributions</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">read 3878 data</span><br><span class="line"> 6 - 1694</span><br><span class="line"> 3 - 18</span><br><span class="line"> 9 -  3</span><br><span class="line"> 7 - 643</span><br><span class="line"> 8 - 115</span><br><span class="line"> 4 - 129</span><br><span class="line"> 5 - 1276</span><br></pre></td></tr></table></figure>

<h2 id="Make-the-Tensor-to-train"><a href="#Make-the-Tensor-to-train" class="headerlink" title="Make the Tensor to train"></a>Make the Tensor to train</h2><p>The data we read from csv in the previous chapter is not Tensor struct which is required by &#96;tch-rs&#96;&#96; crate. The only input it can use is Tensor type.</p>
<p>We use a new interface <code>TrainableData</code> to make an implicit data conversation.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">trait</span> <span class="title class_">TrainableData</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">translate_into</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> T;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">WineQualityTrainData</span> &#123;</span><br><span class="line">    inputs: <span class="type">Vec</span>&lt;<span class="type">f64</span>&gt;,</span><br><span class="line">    output: <span class="type">f64</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Then we implement the interface for <code>WineQualityData</code>, this is also straightforward but time-consuming.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> <span class="title class_">TrainableData</span>&lt;WineQualityTrainData&gt; <span class="keyword">for</span> <span class="title class_">WineQualityData</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">translate_into</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> WineQualityTrainData &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">t</span> = <span class="keyword">match</span> <span class="keyword">self</span>.wine_type.<span class="title function_ invoke__">as_str</span>() &#123;</span><br><span class="line">            <span class="string">&quot;red&quot;</span> =&gt; <span class="number">1.0</span>,</span><br><span class="line">            _ =&gt; <span class="number">0.0</span>,</span><br><span class="line">        &#125;;</span><br><span class="line">        WineQualityTrainData &#123;</span><br><span class="line">            inputs: <span class="built_in">vec!</span>[</span><br><span class="line">                t,</span><br><span class="line">                <span class="keyword">self</span>.fixed_acidity,</span><br><span class="line">                <span class="keyword">self</span>.volatile_acidity,</span><br><span class="line">                <span class="keyword">self</span>.citric_acid,</span><br><span class="line">                <span class="keyword">self</span>.residual_sugar,</span><br><span class="line">                <span class="keyword">self</span>.chlorides,</span><br><span class="line">                <span class="keyword">self</span>.free_sulfur_dioxide,</span><br><span class="line">                <span class="keyword">self</span>.total_sulfur_dioxide,</span><br><span class="line">                <span class="keyword">self</span>.density,</span><br><span class="line">                <span class="keyword">self</span>.pH,</span><br><span class="line">                <span class="keyword">self</span>.sulphates,</span><br><span class="line">                <span class="keyword">self</span>.alcohol,</span><br><span class="line">            ],</span><br><span class="line">            output: <span class="keyword">self</span>.quality,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>And also a <code>GetTensor</code> interface to make the tensor</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">trait</span> <span class="title class_">GetTensor</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">get_x</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> Tensor;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">get_y</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> Tensor;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">GetTensor</span> <span class="keyword">for</span> <span class="title class_">WineQualityTrainData</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">get_x</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> Tensor &#123;</span><br><span class="line">        Tensor::<span class="title function_ invoke__">of_slice</span>(&amp;<span class="keyword">self</span>.inputs)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">get_y</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> Tensor &#123;</span><br><span class="line">        Tensor::<span class="title function_ invoke__">of_slice</span>(&amp;(<span class="built_in">vec!</span>[<span class="keyword">self</span>.output]))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Create-dataset"><a href="#Create-dataset" class="headerlink" title="Create dataset"></a>Create dataset</h2><p>In Python it’s normal to use a training dataset and test dataset to store and use data, so here we implement our own dataset, the dataset code is almost copied from the tch-rs crate mnist dataset implementation, with little modification.</p>
<p>Here we use <code>CustomDataset</code> to store all the data, and <code>CustomIter</code> to iterate the dataset, we can set <code>batch_size</code> to realize batch training.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">CustomDataset</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> size: <span class="type">i32</span>,</span><br><span class="line">    <span class="keyword">pub</span> dataset: Tensor,</span><br><span class="line">    <span class="keyword">pub</span> labels: Tensor,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">CustomIter</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> xs: Tensor,</span><br><span class="line">    <span class="keyword">pub</span> ys: Tensor,</span><br><span class="line">    batch_index: <span class="type">i64</span>,</span><br><span class="line">    batch_size: <span class="type">i64</span>,</span><br><span class="line">    total_size: <span class="type">i64</span>,</span><br><span class="line">    device: Device,</span><br><span class="line">    return_smaller_last_batch: <span class="type">bool</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>for the <code>CustomIter</code> we should implement those functions.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> <span class="title class_">CustomIter</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">shuffle</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;<span class="keyword">mut</span> CustomIter &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">index</span> =</span><br><span class="line">            Tensor::<span class="title function_ invoke__">randperm</span>(<span class="keyword">self</span>.total_size, (Kind::Int64, <span class="keyword">self</span>.device)).<span class="title function_ invoke__">to_device</span>(Device::Cpu);</span><br><span class="line">        <span class="keyword">self</span>.xs = <span class="keyword">self</span>.xs.<span class="title function_ invoke__">index_select</span>(<span class="number">0</span>, &amp;index);</span><br><span class="line">        <span class="keyword">self</span>.ys = <span class="keyword">self</span>.ys.<span class="title function_ invoke__">index_select</span>(<span class="number">0</span>, &amp;index);</span><br><span class="line">        <span class="keyword">self</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">size</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">i64</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.total_size</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">reset</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;<span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.batch_index = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">self</span>.<span class="title function_ invoke__">shuffle</span>();</span><br><span class="line">        <span class="keyword">self</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>(</span><br><span class="line">        xs: &amp;Tensor,</span><br><span class="line">        ys: &amp;Tensor,</span><br><span class="line">        batch_size: <span class="type">i64</span>,</span><br><span class="line">        device: Device,</span><br><span class="line">    ) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;CustomIter, TchError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">total_size</span> = xs.<span class="title function_ invoke__">size</span>()[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span> ys.<span class="title function_ invoke__">size</span>()[<span class="number">0</span>] != total_size &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_ invoke__">Err</span>(TchError::<span class="title function_ invoke__">Shape</span>(<span class="built_in">format!</span>(</span><br><span class="line">                <span class="string">&quot;different dimension for the two inputs &#123;:?&#125; &#123;:?&#125;&quot;</span>,</span><br><span class="line">                xs, ys</span><br><span class="line">            )));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(CustomIter &#123;</span><br><span class="line">            xs: xs.<span class="title function_ invoke__">shallow_clone</span>(),</span><br><span class="line">            ys: ys.<span class="title function_ invoke__">shallow_clone</span>(),</span><br><span class="line">            batch_index: <span class="number">0</span>,</span><br><span class="line">            batch_size,</span><br><span class="line">            total_size,</span><br><span class="line">            device,</span><br><span class="line">            return_smaller_last_batch: <span class="literal">true</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><p>shuffle: rearrange the data order randomly to make the training process more reliable</p>
</li>
<li><p>size: just return the size of the dataset</p>
</li>
<li><p>reset: make the iterator return to the beginning of the dataset</p>
</li>
<li><p>new: create an iterator from the specific dataset</p>
</li>
</ol>
<p>Then we should implement the built-in <code>Iterator</code> trait for our <code>CustomIter</code> to use the for-range loop.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> <span class="title class_">Iterator</span> <span class="keyword">for</span> <span class="title class_">CustomIter</span> &#123;</span><br><span class="line">    <span class="keyword">type</span> <span class="title class_">Item</span> = (Tensor, Tensor);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">next</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;<span class="keyword">Self</span>::Item&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">start</span> = <span class="keyword">self</span>.batch_index * <span class="keyword">self</span>.batch_size;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">size</span> = std::cmp::<span class="title function_ invoke__">min</span>(<span class="keyword">self</span>.batch_size, <span class="keyword">self</span>.total_size - start);</span><br><span class="line">        <span class="keyword">if</span> size &lt;= <span class="number">0</span> || (!<span class="keyword">self</span>.return_smaller_last_batch &amp;&amp; size &lt; <span class="keyword">self</span>.batch_size) &#123;</span><br><span class="line">            <span class="literal">None</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>.batch_index += <span class="number">1</span>;</span><br><span class="line">            <span class="title function_ invoke__">Some</span>((</span><br><span class="line">                <span class="keyword">self</span>.xs.<span class="title function_ invoke__">i</span>(start..start + size).<span class="title function_ invoke__">to_device</span>(<span class="keyword">self</span>.device),</span><br><span class="line">                <span class="keyword">self</span>.ys.<span class="title function_ invoke__">i</span>(start..start + size).<span class="title function_ invoke__">to_device</span>(<span class="keyword">self</span>.device),</span><br><span class="line">            ))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>So the remaining task is to create a dataset from our conversed data.</p>
<p>Just iterate all the data read from csv file and convert it to the Tensor then stack the Tensor into one big Tensor that’s all we need.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">create_dataset</span>&lt;T, E&gt;(data: <span class="type">Vec</span>&lt;T&gt;) <span class="punctuation">-&gt;</span> CustomDataset</span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">        T: TrainableData&lt;E&gt;,</span><br><span class="line">        E: GetTensor,</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">size</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">xs</span> = <span class="type">Vec</span>::&lt;Tensor&gt;::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">ys</span> = <span class="type">Vec</span>::&lt;Tensor&gt;::<span class="title function_ invoke__">new</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">item</span> <span class="keyword">in</span> data.<span class="title function_ invoke__">iter</span>() &#123;</span><br><span class="line">        size += <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">translated_item</span> = item.<span class="title function_ invoke__">translate_into</span>();</span><br><span class="line">        xs.<span class="title function_ invoke__">push</span>(translated_item.<span class="title function_ invoke__">get_x</span>());</span><br><span class="line">        ys.<span class="title function_ invoke__">push</span>(translated_item.<span class="title function_ invoke__">get_y</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">dataset</span> = Tensor::<span class="title function_ invoke__">stack</span>(&amp;xs, <span class="number">0</span>).<span class="title function_ invoke__">to_kind</span>(Kind::Float);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">labels</span> = Tensor::<span class="title function_ invoke__">stack</span>(&amp;ys, <span class="number">0</span>).<span class="title function_ invoke__">to_kind</span>(Kind::Float);</span><br><span class="line">    CustomDataset &#123;</span><br><span class="line">        size,</span><br><span class="line">        dataset,</span><br><span class="line">        labels,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Train-model"><a href="#Train-model" class="headerlink" title="Train model"></a>Train model</h2><p>Now everything is fine we can play with the network model.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">LinearRegressionTrainer</span> &#123;</span><br><span class="line">    device: Device,</span><br><span class="line">    iter: <span class="type">Option</span>&lt;CustomIter&gt;,</span><br><span class="line">    test_iter: <span class="type">Option</span>&lt;CustomIter&gt;,</span><br><span class="line">    opt: <span class="type">Option</span>&lt;Optimizer&gt;,</span><br><span class="line">    <span class="keyword">pub</span> epoch: <span class="type">i32</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Then we implement the build network function for the Trainer</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">LinearRegressionBuilder</span> &#123;&#125;</span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">LinearRegressionBuilder</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">build</span>(vs: &amp;nn::Path) <span class="punctuation">-&gt;</span> <span class="keyword">impl</span> <span class="title class_">Module</span> &#123;</span><br><span class="line">        nn::<span class="title function_ invoke__">seq</span>()</span><br><span class="line">            .<span class="title function_ invoke__">add</span>(nn::<span class="title function_ invoke__">linear</span>(vs, <span class="number">12</span>, <span class="number">512</span>, <span class="built_in">Default</span>::<span class="title function_ invoke__">default</span>()))</span><br><span class="line">            .<span class="title function_ invoke__">add_fn</span>(|xs| xs.<span class="title function_ invoke__">relu</span>())</span><br><span class="line">            .<span class="title function_ invoke__">add</span>(nn::<span class="title function_ invoke__">linear</span>(vs, <span class="number">512</span>, <span class="number">512</span>, <span class="built_in">Default</span>::<span class="title function_ invoke__">default</span>()))</span><br><span class="line">            .<span class="title function_ invoke__">add_fn</span>(|xs| xs.<span class="title function_ invoke__">relu</span>())</span><br><span class="line">            .<span class="title function_ invoke__">add</span>(nn::<span class="title function_ invoke__">linear</span>(vs, <span class="number">512</span>, <span class="number">512</span>, <span class="built_in">Default</span>::<span class="title function_ invoke__">default</span>()))</span><br><span class="line">            .<span class="title function_ invoke__">add_fn</span>(|xs| xs.<span class="title function_ invoke__">relu</span>())</span><br><span class="line">            .<span class="title function_ invoke__">add</span>(nn::<span class="title function_ invoke__">linear</span>(vs, <span class="number">512</span>, <span class="number">1</span>, <span class="built_in">Default</span>::<span class="title function_ invoke__">default</span>()))</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>Finally we can make our training function, we use <code>Adam</code> as the optimizer and <code>F1</code> Loss&#96; as our loss function, the code organized is exactly the same as pytorch, we follow the steps that in every epoch take batch from the training dataset and feed to the network model then use opt to optimize the parameters, finally use the test set(if exist) to get the result of our model.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> <span class="title class_">LinearRegressionTrainer</span>&#123;</span><br><span class="line">     <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">train</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;(), <span class="type">Box</span>&lt;<span class="keyword">dyn</span> Error&gt;&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">None</span> = <span class="keyword">self</span>.iter &#123;</span><br><span class="line">            <span class="built_in">panic!</span>(<span class="string">&quot;No data&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">iter</span> = <span class="keyword">self</span>.iter.<span class="title function_ invoke__">as_mut</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">vs</span> = nn::VarStore::<span class="title function_ invoke__">new</span>(<span class="keyword">self</span>.device);</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">net</span> = LinearRegressionBuilder::<span class="title function_ invoke__">build</span>(&amp;vs.<span class="title function_ invoke__">root</span>());</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;net is ready&quot;</span>);</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">opt</span> = nn::Adam::<span class="title function_ invoke__">default</span>().<span class="title function_ invoke__">build</span>(&amp;vs, <span class="number">1e-5</span>)?;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;opt is ready&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> <span class="variable">epoch</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="keyword">self</span>.epoch &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">total_loss</span> = <span class="number">0</span> <span class="keyword">as</span> <span class="type">f64</span>;</span><br><span class="line">            iter.<span class="title function_ invoke__">reset</span>();</span><br><span class="line"></span><br><span class="line">            total_loss = <span class="number">0.0</span>;</span><br><span class="line">            <span class="built_in">print!</span>(<span class="string">&quot;epoch &#123;:4&#125;/&#123;:4&#125; is start&quot;</span>, epoch, <span class="keyword">self</span>.epoch);</span><br><span class="line">            <span class="keyword">for</span> <span class="variable">batch</span> <span class="keyword">in</span> iter.<span class="title function_ invoke__">into_iter</span>() &#123;</span><br><span class="line">                <span class="keyword">let</span> <span class="variable">loss</span> =</span><br><span class="line">                    net.<span class="title function_ invoke__">forward</span>(&amp;batch.<span class="number">0</span>)</span><br><span class="line">                        .<span class="title function_ invoke__">f_smooth_l1_loss</span>(&amp;batch.<span class="number">1</span>, tch::Reduction::Mean, <span class="number">1.0</span>)?;</span><br><span class="line">                opt.<span class="title function_ invoke__">backward_step</span>(&amp;loss);</span><br><span class="line">                opt.<span class="title function_ invoke__">zero_grad</span>();</span><br><span class="line">                total_loss += <span class="type">f64</span>::<span class="title function_ invoke__">from</span>(&amp;loss);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">print!</span>(<span class="string">&quot; loss &#123;:4&#125;&quot;</span>, total_loss);</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Some</span>(test_iter) = <span class="keyword">self</span>.test_iter.<span class="title function_ invoke__">as_mut</span>() &#123;</span><br><span class="line">                test_iter.<span class="title function_ invoke__">reset</span>();</span><br><span class="line">                <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">total_loss</span> = <span class="number">0</span> <span class="keyword">as</span> <span class="type">f64</span>;</span><br><span class="line">                <span class="keyword">for</span> <span class="variable">batch</span> <span class="keyword">in</span> test_iter.<span class="title function_ invoke__">into_iter</span>() &#123;</span><br><span class="line">                    <span class="keyword">let</span> <span class="variable">loss</span> = net</span><br><span class="line">                        .<span class="title function_ invoke__">forward</span>(&amp;batch.<span class="number">0</span>)</span><br><span class="line">                        .<span class="title function_ invoke__">f_l1_loss</span>(&amp;batch.<span class="number">1</span>, tch::Reduction::Mean)?;</span><br><span class="line">                    total_loss += <span class="type">f64</span>::<span class="title function_ invoke__">from</span>(&amp;loss);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">println!</span>(<span class="string">&quot; test loss &#123;:4&#125;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="Main-func"><a href="#Main-func" class="headerlink" title="Main func"></a>Main func</h2><p>we put all the below things together and write a main function read data and train the model.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;(), <span class="type">Box</span>&lt;<span class="keyword">dyn</span> Error&gt;&gt; &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Cuda available: &#123;&#125;&quot;</span>, Cuda::<span class="title function_ invoke__">is_available</span>());</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Cudnn available: &#123;&#125;&quot;</span>, Cuda::<span class="title function_ invoke__">cudnn_is_available</span>());</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">cuda_device</span> = Device::<span class="title function_ invoke__">cuda_if_available</span>();</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;App works on &#123;:?&#125;&quot;</span>, cuda_device);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">reader</span> = CsvReader::<span class="title function_ invoke__">new</span>(<span class="string">&quot;./wine_dataset/train.csv&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">data</span>: <span class="type">Vec</span>&lt;WineQualityData&gt; = reader.<span class="title function_ invoke__">get_data</span>()?;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">data</span> = <span class="title function_ invoke__">create_dataset</span>(data);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">iter</span> = CustomIter::<span class="title function_ invoke__">new</span>(&amp;data.dataset, &amp;data.labels, *BATCHSIZE, cuda_device)?;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">test_data</span> = data.<span class="title function_ invoke__">clone</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">test_data</span> = <span class="title function_ invoke__">create_dataset</span>(test_data);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">test_iter</span> = CustomIter::<span class="title function_ invoke__">new</span>(</span><br><span class="line">        &amp;test_data.dataset,</span><br><span class="line">        &amp;test_data.labels,</span><br><span class="line">        test_data.size <span class="keyword">as</span> <span class="type">i64</span>,</span><br><span class="line">        cuda_device,</span><br><span class="line">    )?;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;total train data &#123;&#125;&quot;</span>, iter.<span class="title function_ invoke__">size</span>());</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">train</span> = LinearRegressionTrainer::<span class="title function_ invoke__">new</span>(cuda_device);</span><br><span class="line">    train.<span class="title function_ invoke__">set_data</span>(iter);</span><br><span class="line">    train.<span class="title function_ invoke__">set_test_data</span>(test_iter);</span><br><span class="line">    train.<span class="title function_ invoke__">train</span>()?;</span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br></pre></td></tr></table></figure>

<p>for predict functionality, it can be implemented as same as the training process, just feed with the parameters and it will return the output, here we use the round function to make the result convert to an i32 type.</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>We have made our own simple implementation of datareader, dataset, and linear regression model with futures from reading to training, from training to prediction.<br>But we should use <code>Python</code> to make prototypes and search in most cases. From the <code>tch-rs</code> github issues and other forums like Reddit, we can see various talking about rust ml, the only scenario we should use rust is the high performance and portability required, not the training process and data handling.</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/rust/" rel="tag"># rust</a>
              <a href="/tags/machine-learning/" rel="tag"># machine learning</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/posts/54798/" rel="prev" title="C++文件库实践 filesystem">
      <i class="fa fa-chevron-left"></i> C++文件库实践 filesystem
    </a></div>
      <div class="post-nav-item"></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Introduction"><span class="nav-number">1.</span> <span class="nav-text">Introduction</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Read-data"><span class="nav-number">2.</span> <span class="nav-text">Read data</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Make-the-Tensor-to-train"><span class="nav-number">3.</span> <span class="nav-text">Make the Tensor to train</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Create-dataset"><span class="nav-number">4.</span> <span class="nav-text">Create dataset</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Train-model"><span class="nav-number">5.</span> <span class="nav-text">Train model</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Main-func"><span class="nav-number">6.</span> <span class="nav-text">Main func</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Conclusion"><span class="nav-number">7.</span> <span class="nav-text">Conclusion</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">YuSheng Xu</p>
  <div class="site-description" itemprop="description">Study & Work & Life</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">3</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">YuSheng Xu</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
      <span class="post-meta-item-text">Symbols count total: </span>
    <span title="Symbols count total">53k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">Reading time total &asymp;</span>
    <span title="Reading time total">48 mins.</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
